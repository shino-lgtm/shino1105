<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { 
        getAuth, 
        GoogleAuthProvider, 
        GithubAuthProvider, 
        signInWithPopup, 
        signInWithRedirect,
        getRedirectResult,
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged,
        signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // Firebaseè¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyBH8EPKOwIBIMR16Z7PTECc2Lp0Y5cfkHQ",
        authDomain: "november5th-a1336.firebaseapp.com",
        projectId: "november5th-a1336",
        storageBucket: "november5th-a1336.firebasestorage.app",
        messagingSenderId: "11537951889",
        appId: "1:11537951889:web:d783b2298fc90f88a3a330",
    };

    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    const githubProvider = new GithubAuthProvider();

    // HTMLè¦ç´ 
    const userStatusDiv = document.getElementById('user-status');
    const loginSection = document.getElementById('login-section');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const githubLoginBtn = document.getElementById('github-login-btn');
    const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
    const emailSignupBtn = document.getElementById('email-signup-btn');
    const emailLoginBtn = document.getElementById('email-login-btn');
    const errorMessageParagraph = document.getElementById('error-message');

    loginSection.style.display = 'none';

    function setUiState(isLoading, message = '') {
        emailInput.disabled = isLoading;
        passwordInput.disabled = isLoading;
        googleLoginBtn.disabled = isLoading;
        githubLoginBtn.disabled = isLoading;
        anonymousLoginBtn.disabled = isLoading;
        emailSignupBtn.disabled = isLoading;
        emailLoginBtn.disabled = isLoading;
        userStatusDiv.textContent = message;
        if (!isLoading) errorMessageParagraph.textContent = '';
    }

    // ğŸ”¥ GitHub redirect ã®çµæœã‚’å‡¦ç†ï¼ˆé‡è¦ï¼‰
    getRedirectResult(auth).catch(error => {
        if (error) {
            console.error("GitHub redirect error:", error);
            handleError(error, "GitHubãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
    });

    // èªè¨¼çŠ¶æ…‹ç›£è¦–
    onAuthStateChanged(auth, (user) => {
        if (user) {
            setUiState(true, 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€‚ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™...');
            setTimeout(() => {
                window.location.href = 'mypage.html';
            }, 1500);
        } else {
            setUiState(false, 'æœªãƒ­ã‚°ã‚¤ãƒ³');
            loginSection.style.display = 'block';
        }
    });

    // Googleãƒ­ã‚°ã‚¤ãƒ³ï¼ˆChromeå‘ã‘ã«Popupç¶™ç¶šï¼‰
    googleLoginBtn.addEventListener('click', async () => {
        setUiState(true, 'Googleèªè¨¼ä¸­...');
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) { handleError(error, "Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    });

    // GitHubãƒ­ã‚°ã‚¤ãƒ³ï¼ˆFirefoxå¯¾å¿œï¼šRedirectç‰ˆï¼‰
    githubLoginBtn.addEventListener('click', async () => {
        setUiState(true, 'GitHubèªè¨¼ä¸­...');
        try {
            await signInWithRedirect(auth, githubProvider);
        } catch (error) { handleError(error, "GitHubãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    });

    // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
    anonymousLoginBtn.addEventListener('click', async () => {
        setUiState(true, 'ã‚²ã‚¹ãƒˆã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
        try {
            await signInAnonymously(auth);
        } catch (error) { handleError(error, "åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    });

    // Emailã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
    emailSignupBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) { errorMessageParagraph.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; return; }
        setUiState(true, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆä¸­...');
        try { await createUserWithEmailAndPassword(auth, email, password); } 
        catch (error) { handleError(error, "Emailã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    });

    // Emailãƒ­ã‚°ã‚¤ãƒ³
    emailLoginBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) { errorMessageParagraph.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; return; }
        setUiState(true, 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
        try { await signInWithEmailAndPassword(auth, email, password); } 
        catch (error) { handleError(error, "Emailãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    });

    function handleError(error, prefix = "ã‚¨ãƒ©ãƒ¼") {
        console.error(prefix, error);
        let displayMessage = prefix + ": ";
        switch (error.code) {
            case 'auth/popup-closed-by-user': displayMessage = "ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚"; break;
            case 'auth/invalid-email': displayMessage = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"; break;
            case 'auth/wrong-password':
            case 'auth/user-not-found': displayMessage = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"; break;
            case 'auth/network-request-failed': displayMessage = "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œã«ã‚ˆã‚Šå¤±æ•—ã—ã¾ã—ãŸã€‚"; break;
            default: displayMessage += error.message;
        }
        errorMessageParagraph.textContent = displayMessage;
        setUiState(false, 'æœªãƒ­ã‚°ã‚¤ãƒ³');
    }
</script>
